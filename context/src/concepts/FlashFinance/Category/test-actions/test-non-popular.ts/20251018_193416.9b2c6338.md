---
timestamp: 'Sat Oct 18 2025 19:34:16 GMT-0400 (Eastern Daylight Time)'
content_id: 9b2c6338c6eb9cd2063e732f643a66b7604c909f6d2a445e501e817f628571e3
---

# file: src/concepts/FlashFinance/Category/test-actions/test-non-popular.ts

```typescript
import { assertEquals, assertExists, assertRejects } from "jsr:@std/assert";
import { testDb } from "@utils/database.ts";
import { CategoryStore, Id, Period } from "../category.ts"; // Adjust path if category.ts is not in the parent directory

Deno.test("CategoryStore: renaming a category does not affect its existing metrics", async () => {
  const [db, client] = await testDb();
  const store = new CategoryStore(db);

  try {
    const ownerId = Id.from("test_user_rename_metrics");
    const initialName = "Rent";
    const newName = "Housing Expenses";

    const periodJan = Period.from(
      new Date("2023-01-01T00:00:00.000Z"),
      new Date("2023-01-31T23:59:59.999Z"),
    );
    const totalJan = 1200.50;

    const periodFeb = Period.from(
      new Date("2023-02-01T00:00:00.000Z"),
      new Date("2023-02-28T23:59:59.999Z"),
    );
    const totalFeb = 1250.75;

    // 1. Setup: Create category and set two metrics.
    const { category_id: categoryId } = await store.create(
      ownerId,
      initialName,
    );
    assertExists(categoryId, "Category should be created successfully.");
    await store.setMetricTotal(ownerId, categoryId, periodJan, totalJan);
    await store.setMetricTotal(ownerId, categoryId, periodFeb, totalFeb);

    // Pre-verification: Confirm metrics are retrievable before rename.
    const metricJanBeforeRename = await store.getMetric(
      ownerId,
      categoryId,
      periodJan,
    );
    assertEquals(
      metricJanBeforeRename?.current_total,
      totalJan,
      "January metric total should be correct before rename.",
    );

    // 2. Proof: Rename the category succeeds.
    const { category_id: renamedCategoryId } = await store.rename(
      ownerId,
      categoryId,
      newName,
    );
    assertEquals(
      renamedCategoryId.toString(),
      categoryId.toString(),
      "Renamed category ID should match original ID.",
    );

    // 3. Proof: Metrics are still retrievable with the original category_id and their totals are unchanged.
    const metricJanAfterRename = await store.getMetric(
      ownerId,
      categoryId,
      periodJan,
    );
    assertEquals(
      metricJanAfterRename?.current_total,
      totalJan,
      "January metric total should remain unchanged after rename.",
    );
    const metricFebAfterRename = await store.getMetric(
      ownerId,
      categoryId,
      periodFeb,
    );
    assertEquals(
      metricFebAfterRename?.current_total,
      totalFeb,
      "February metric total should remain unchanged after rename.",
    );

    // 4. Proof: `listMetrics` still returns all associated metrics correctly, maintaining sort order.
    const listedMetricsAfterRename = await store.listMetrics(
      ownerId,
      categoryId,
    );
    assertEquals(
      listedMetricsAfterRename.length,
      2,
      "listMetrics should still return two metrics.",
    );
    assertEquals(
      listedMetricsAfterRename[0].period_start.toISOString(),
      periodJan.startDate.toISOString(),
      "First listed metric should be January (sorted).",
    );
  } finally {
    await client.close(true);
  }
});

```
